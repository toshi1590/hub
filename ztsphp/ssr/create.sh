{
  echo "<?php"
  echo ""
  echo "\$start_time = microtime(true);"
  echo ""
  echo "\$url = '$1';"
  echo "\$column_numbers_to_scrape = $2;"
  echo "\$titles = $3;"
  echo "\$rows = $4;"
  echo "\$xpath_of_a = '$5';"
  echo "\$xpaths_to_scrape_in_a_new_page = $6;"
  echo "\$parameter = '$7';"
  echo "\$pages = $8;"
  echo "\$urls = [];"
  echo "\$html = file_get_contents(\$url);"
  echo "\$dom = new DOMDocument();"
  echo "@\$dom->loadHTML(\$html);"
  echo "\$xpath = new DOMXPath(\$dom);"
  echo "\$data = [];"
  echo "\$hrefs = [];"
  echo "array_push(\$data, \$titles);"
  echo ""
  echo "if (\$parameter != 'null' && \$pages != 1) {"
  echo "  if (preg_match(\"/\$parameter=[0-9]+/\", \$url)) {"
  echo "    for (\$i = 1; \$i <= \$pages; \$i++) {"
  echo "      array_push(\$urls, preg_replace(\"/\$parameter=[0-9]+/\", \"\${parameter}=\$i\", \$url));"
  echo "    }"
  echo "  } else {"
  echo "    exit('matching error');"
  echo "  }"
  echo "} else {"
  echo "  \$pages = 1;"
  echo "  array_push(\$urls, \$url);"
  echo "}"
  echo ""
  echo "for (\$i = 1; \$i <= \$pages; \$i++) {"
  echo "  \${'runtime'.\$i} = new \parallel\Runtime();"
  echo "}"
  echo ""
} > scraping.php

for i in `seq $8`
do
  {
    echo "\$future${i} = \$runtime${i}->run(function(\$url, \$column_numbers_to_scrape, \$rows, \$xpath_of_a){"
    echo "  \$html = file_get_contents(\$url);"
    echo "  \$dom = new DOMDocument();"
    echo "  @\$dom->loadHTML(\$html);"
    echo "  \$xpath = new DOMXPath(\$dom);"
    echo "  \$data = [];"
    echo "  \$hrefs = [];"
    echo "  \$data_hrefs = [];"
    echo ""
    echo "  for (\$i = 1; \$i <= \$rows; \$i++) {"
    echo "    try {"
    echo "      \$tr_tds = [];"
    echo "      "
    echo "      for (\$j = 0; \$j < count(\$column_numbers_to_scrape); \$j++) {"
    echo "        if (\$xpath->query(\"//tr[\$i]/td[\$column_numbers_to_scrape[\$j]]\")->item(0) == null) {"
    echo "          continue 2;"
    echo "        } else {"
    echo "          array_push(\$tr_tds, \$xpath->query(\"//tr[\$i]/td[\$column_numbers_to_scrape[\$j]]\")->item(0)->nodeValue);"
    echo "        }"
    echo "      }"
    echo ""
    echo "      array_push(\$data, \$tr_tds);"
    echo ""
    echo "      if (\$xpath_of_a != 'null') {"
    echo "        \$preg_xpath_of_a = preg_replace(\"/tr\[[0-9]+\]/\", \"tr[\$i]\", \$xpath_of_a);"
    echo "        \$a = \$xpath->query(\$preg_xpath_of_a)->item(0);"
    echo "        \$href = \$a->getAttribute('href');"
    echo "        array_push(\$hrefs, \$href);"
    echo "      }"
    echo "    } catch (Throwable \$t) {"
    echo "      continue;"
    echo "    } catch (Exception \$e) {"
    echo "      continue;"
    echo "    }"
    echo "  }"
    echo ""
    echo "  array_push(\$data_hrefs, \$data);"
    echo "  array_push(\$data_hrefs, \$hrefs);"
    echo ""
    echo "  return \$data_hrefs;"
    echo "}, array(\$urls[$(echo $(($i - 1)))], \$column_numbers_to_scrape, \$rows, \$xpath_of_a));"
    echo ""
  } >> scraping.php
done

{
  echo "for (\$i = 1; \$i <= \$pages; \$i++) {"
  echo "  \$data = array_merge(\$data, \${'future'.\$i}->value()[0]);"
  echo "  \$hrefs = array_merge(\$hrefs, \${'future'.\$i}->value()[1]);"
  echo "}"
  echo ""
#  echo "var_dump(\$data);"
#  echo "var_dump(\$hrefs);"
  echo ""
} >> scraping.php


if [ $9 -gt 0 ]; then
  {
    echo "for (\$i = 1; \$i <= count(\$hrefs); \$i++) {"
    echo "  \${'href_runtime'.\$i} = new \parallel\Runtime();"
    echo "}"
    echo ""
  } >> scraping.php
fi

for i in `seq $9`
do
  {
    echo "\$href_future${i} = \$href_runtime${i}->run(function(\$href, \$xpaths_to_scrape_in_a_new_page){"
    echo "  \$html = file_get_contents(\$href);"
    echo "  \$dom = new DOMDocument();"
    echo "  @\$dom->loadHTML(\$html);"
    echo "  \$xpath = new DOMXPath(\$dom);"
    echo "  \$data = [];"
    echo ""
    echo "  for (\$i = 0; \$i < count(\$xpaths_to_scrape_in_a_new_page); \$i++) {"
    echo "    \$value = \$xpath->query(\$xpaths_to_scrape_in_a_new_page[\$i])->item(0)->nodeValue;"
    echo "    array_push(\$data, \$value);"
    echo "  }"
    echo ""
    echo "  return \$data;"
    echo "}, array(\$hrefs[$(echo $(($i - 1)))], \$xpaths_to_scrape_in_a_new_page));"
    echo ""
  } >> scraping.php
done


if [ $9 -gt 0 ]; then
  {
    echo "for (\$i = 1; \$i < count(\$data); \$i++) {"
    echo "  for (\$j = 0; \$j < count(\${'href_future'.\$i}->value()); \$j++) {"
    echo "    array_push(\$data[\$i], \${'href_future'.\$i}->value()[\$j]);"
    echo "  }"
    echo "}"
    echo ""
  } >> scraping.php
fi

#echo "var_dump(\$data);" >> scraping.php

{
  echo "\$end_time = microtime(true);"
  echo "\$execution_time = (\$end_time - \$start_time);"
  echo ""
  echo "for (\$i = 0; \$i < count(\$data); \$i++) {"
  echo "  if (\$i == 0) {"
  echo "    array_unshift(\$data[\$i], 'id');"
  echo "  } else {"
  echo "    //array_unshift(\$data[\$i], \$i);"
  echo "    array_unshift(\$data[\$i], \$execution_time);"
  echo "  }"
  echo "}"
  echo ""
  echo ""
  echo "\$handle = fopen(\"check.txt\", \"a\");"
  echo ""
  echo "for (\$i = 0; \$i < count(\$data); \$i++) {"
  echo "  for (\$j = 0; \$j < count(\$data[\$i]); \$j++) {"
  echo "    fwrite(\$handle, \$data[\$i][\$j]. \"\n\");"
  echo "  }"
  echo "}"
  echo ""
  echo "fclose(\$handle);"
  echo ""
  echo ""
  echo "\$handle = fopen(\"result.txt\", \"a\");"
  echo "\$number_of_data = count(\$data);"
  echo "fwrite(\$handle, \"\$pages / \$number_of_data / \$execution_time\" . \"\n\");"
  echo "fclose(\$handle);"
  echo "?>"
  echo ""
} >> scraping.php

{
  echo "<script type=\"text/javascript\">"
  echo "  const data = JSON.parse('<?php echo json_encode(\$data); ?>');"
#  echo "  console.log(data);"
  echo "</script>"
  echo ""
  echo ""
} >> scraping.php

{
  echo "<!doctype html>"
  echo "<html lang=\"en\">"
  echo "  <head>"
  echo "    <meta charset=\"utf-8\">"
  echo "    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">"
  echo "    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css\" rel=\"stylesheet\" integrity=\"sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU\" crossorigin=\"anonymous\">"
  echo "    <link rel=\"stylesheet\" href=\"http://localhost:81/ssr/index.css\">"
  echo "  </head>"
  echo "  <body class=\"m-1\">"
  echo "    <div id=\"result_table_section\"></div>"
  echo ""
  echo "    <form class=\"mb-5\" id=\"chart_form\">"
  echo "      <div class=\"form-check\">"
  echo "        <input class=\"form-check-input\" type=\"radio\" name=\"condition\" id=\"group_by_a_column_radio\">group by a column"
  echo "        <div id=\"group_by_a_column_section\"></div>"
  echo "      </div>"
  echo ""
  echo "      <div class=\"form-check\">"
  echo "        <input class=\"form-check-input\" type=\"radio\" name=\"condition\" id=\"range_radio\">range"
  echo "        <div id=\"range_section\"></div>"
  echo "      </div>"
  echo ""
  echo "      <div class=\"form-check\">"
  echo "        <input class=\"form-check-input\" type=\"radio\" name=\"condition\" id=\"keyword_radio\">keyword"
  echo "        <div id=\"keyword_section\"></div>"
  echo "      </div>"
  echo ""
  echo "      <button type=\"button\" class=\"btn btn-primary\" id=\"see_chart_btn\">see chart</button>"
  echo "    </form>"
  echo ""
  echo "    <div id=\"chart_section\"></div>"
  echo ""
  echo "    <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js\"></script>"
  echo "    <script type=\"text/javascript\" src=\"http://localhost:81/ssr/paginathing.js\"></script>"
  echo "    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js\"></script>"
  echo "    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js\"></script>"
  echo "    <script src=\"http://localhost:81/ssr/background_colors.js\"></script>"
  echo "    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js\" integrity=\"sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ\" crossorigin=\"anonymous\"></script>"
  echo "    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.min.js\" integrity=\"sha384-skAcpIdS7UcVUC05LJ9Dxay8AXcDYfBJqt1CJ85S/CFujBsIzCIv+l9liuYLaMQ/\" crossorigin=\"anonymous\"></script>"
  echo "    <script src=\"http://localhost:81/ssr/list_chart.js\"></script>"
  echo "  </body>"
  echo "</html>"
} >> scraping.php
